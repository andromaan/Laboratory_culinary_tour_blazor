@page "/gastro_facility"
@using System.Text.Json
@using culinary_tour_blazor.ClientSide.Entities
@using culinary_tour_blazor.ClientSide.HttpServices
@inject NavigationManager Navigation
@inject GastroFacilityHttpService GastroFacilityService
@inject IJSRuntime JSRuntime

<h3>GastroFacility</h3>

<a class="btn btn-primary my-2" role="button" href="/gastro_facility/create">Додати заклад</a>

@if (GastroFacilityList is null)
{
    <div class="alert alert-info">Заклади відсутні!</div>
}
else
{
    <br />
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 container-xxl">
        @foreach (var gf in GastroFacilityList)
        {
            <div class="col">
                <div class="card zoom-on-hover">
                    <a href="#" class="d-flex justify-content-center">
                        @if (gf.Photo != null)
                        {
                            <img src="data:image/png;base64,@Convert.ToBase64String(gf.Photo)" class="card-img-top" alt="Зображення гастрозакладу" style="width: auto; height: auto; max-width: 100%; max-height: 50vh;">
                        }
                        else
                        {
                            <img src="default_image.jpg" class="card-img-top" alt="Зображення гастрозакладу" style="width: auto; height: auto; max-width: 100%; max-height: 50vh;">
                        }
                    </a>
                    <div class="card-body d-flex flex-column justify-content-between">
                        <div>
                            <h5 class="card-title">@gf.Name</h5>
                            <p class="card-text">Тип: @gf.Type?.Name</p>
                            <p class="card-text">
                                Кухні:
                                @if (gf.Cuisines != null && gf.Cuisines.Any())
                                {
                                    @foreach (var cuisine in gf.Cuisines)
                                    {
                                        <span class="d-inline-flex align-items-center font-weight-medium rounded-2 text-sm px-1 border border-dark-subtle bg-body-secondary">@cuisine.Name </span>
                                    }
                                }
                                else
                                {
                                    <span>Не вказано</span>
                                }
                            </p>
                            <div class="ratingDiv">
                                <span class="my-rating" data-rating="@gf.RatingAvg?.ToString("F1").Replace(",", ".")"></span>
                            </div>
                        </div>
                        @* Only show edit and delete buttons if the user is in the "Admin" role *@
                        @if (true)
                        {
                            <div class="mr-2 d-flex justify-content-around my-3 buttons">
                                <div>
                                    <button class="btn btn-danger" @onclick="() => ConfirmDelete(gf.Id)">Видалення</button>
                                </div>
                                <div>
                                    <a href="@($"gastro_facility/edit/{gf.Id}")" class="btn btn-primary">Редагування</a>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<GastroFacilityItem> GastroFacilityList = new List<GastroFacilityItem>();

    protected override async Task OnInitializedAsync()
    {
        GastroFacilityList = await GastroFacilityService.GetAllAsync();
    }

    private async Task Delete(Guid id)
    {
        await GastroFacilityService.DeleteAsync(id);
        GastroFacilityList = await GastroFacilityService.GetAllAsync();
    }

    private async Task ConfirmDelete(Guid id)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", new object[] { "Are you sure you want to delete this facility?" });
        if (confirmed)
        {
            await Delete(id);
        }
    }
}
